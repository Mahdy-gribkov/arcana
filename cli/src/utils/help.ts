import { existsSync, mkdirSync, writeFileSync } from "node:fs";
import { join } from "node:path";
import { homedir } from "node:os";
import * as p from "@clack/prompts";
import chalk from "chalk";
import { ui } from "./ui.js";

const noColor = !!(process.env.NO_COLOR || process.env.TERM === "dumb");

function amberShade(hex: string, text: string): string {
  if (noColor) return text;
  return chalk.hex(hex)(text);
}

const AMBER_HEXES = [
  "#e8a84c",  // bright amber
  "#d4943a",  // brand amber
  "#c0842f",  // mid
  "#a87228",  // darker
  "#8f6020",  // dimmer
  "#755019",  // darkest
];

const BANNER_LINES = [
  " █████╗ ██████╗  ██████╗ █████╗ ███╗   ██╗ █████╗ ",
  "██╔══██╗██╔══██╗██╔════╝██╔══██╗████╗  ██║██╔══██╗",
  "███████║██████╔╝██║     ███████║██╔██╗ ██║███████║",
  "██╔══██║██╔══██╗██║     ██╔══██║██║╚██╗██║██╔══██║",
  "██║  ██║██║  ██║╚██████╗██║  ██║██║ ╚████║██║  ██║",
  "╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝",
];

export function renderBanner(): string {
  if (noColor) {
    return BANNER_LINES.map((l) => `  ${l}`).join("\n");
  }
  return BANNER_LINES.map((line, i) => `  ${amberShade(AMBER_HEXES[i]!, line)}`).join("\n");
}

interface CommandEntry {
  cmd: string;
  desc: string;
}

const COMMAND_GROUPS: Record<string, CommandEntry[]> = {
  "GETTING STARTED": [
    { cmd: "init", desc: "Initialize arcana in current project" },
    { cmd: "doctor", desc: "Check environment and diagnose issues" },
  ],
  SKILLS: [
    { cmd: "list", desc: "List available skills" },
    { cmd: "search <query>", desc: "Search across providers" },
    { cmd: "info <skill>", desc: "Show skill details" },
    { cmd: "install [skills...]", desc: "Install one or more skills" },
    { cmd: "update [skills...]", desc: "Update installed skills" },
    { cmd: "uninstall [skills...]", desc: "Remove one or more skills" },
  ],
  DEVELOPMENT: [
    { cmd: "create <name>", desc: "Create a new skill from template" },
    { cmd: "validate [skill]", desc: "Validate skill structure" },
    { cmd: "audit [skill]", desc: "Audit skill quality" },
  ],
  CONFIGURATION: [
    { cmd: "config [key] [val]", desc: "View or modify configuration" },
    { cmd: "providers", desc: "Manage skill providers" },
    { cmd: "clean", desc: "Remove orphaned data" },
    { cmd: "stats", desc: "Show session analytics" },
  ],
};

const EXAMPLES = [
  "$ arcana install code-reviewer typescript golang",
  '$ arcana search "testing"',
  "$ arcana init --tool claude",
];

function padRight(str: string, width: number): string {
  return str + " ".repeat(Math.max(0, width - str.length));
}

export function buildCustomHelp(version: string): string {
  const lines: string[] = [];

  lines.push("");
  lines.push(renderBanner());
  lines.push("");
  lines.push(`  ${ui.bold("Supercharge any AI coding agent.")}${" ".repeat(20)}${ui.dim(`v${version}`)}`);
  lines.push("");
  lines.push(`  ${ui.dim("USAGE")}`);
  lines.push("    arcana <command> [options]");

  for (const [group, commands] of Object.entries(COMMAND_GROUPS)) {
    lines.push("");
    lines.push(`  ${ui.dim(group)}`);
    for (const { cmd, desc } of commands) {
      lines.push(`    ${ui.cyan(padRight(cmd, 22))}${ui.dim(desc)}`);
    }
  }

  lines.push("");
  lines.push(`  ${ui.dim("EXAMPLES")}`);
  for (const ex of EXAMPLES) {
    lines.push(`    ${ui.cyan(ex)}`);
  }

  lines.push("");
  lines.push(`  ${ui.dim("LEARN MORE")}`);
  lines.push(`    arcana <command> --help          ${ui.dim("Show help for a command")}`);
  lines.push(`    ${ui.dim("https://github.com/medy-gribkov/arcana")}`);
  lines.push("");

  return lines.join("\n");
}

const FIRST_RUN_FLAG = join(homedir(), ".arcana", ".initialized");

export function isFirstRun(): boolean {
  return !existsSync(FIRST_RUN_FLAG);
}

export function markInitialized(): void {
  const dir = join(homedir(), ".arcana");
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true });
  }
  writeFileSync(FIRST_RUN_FLAG, new Date().toISOString(), "utf-8");
}

export function showWelcome(version: string): void {
  console.log();
  console.log(renderBanner());
  console.log();
  p.intro(chalk.hex("#d4943a").bold(`arcana v${version}`));
  p.log.step(chalk.bold("Welcome! Arcana is a universal skill manager for AI coding agents."));
  p.log.info("Skills extend your agent (Claude, Cursor, Codex, etc.) with expert knowledge.");
  p.log.info("They install on-demand and only load when relevant, not all at once.");
  console.log();
}

