import chalk from "chalk";
import ora, { type Ora } from "ora";

const AMBER = chalk.hex("#d4943a");

export const ui = {
  brand: (text: string) => AMBER.bold(text),
  success: (text: string) => chalk.green(text),
  error: (text: string) => chalk.red(text),
  warn: (text: string) => chalk.yellow(text),
  dim: (text: string) => chalk.dim(text),
  bold: (text: string) => chalk.bold(text),
  cyan: (text: string) => chalk.cyan(text),
};

export function banner(): void {
  console.log();
  console.log(ui.brand("  arcana") + ui.dim(" - universal agent skill manager"));
  console.log();
}

export function spinner(text: string): Ora {
  return ora({ text, color: "yellow" });
}

const ANSI_REGEX = /\x1b\[[0-9;]*m/g;

function stripAnsi(str: string): string {
  return str.replace(ANSI_REGEX, "");
}

function padWithAnsi(str: string, width: number): string {
  const visible = stripAnsi(str).length;
  const padding = Math.max(0, width - visible);
  return str + " ".repeat(padding);
}

export function table(rows: string[][]): void {
  if (rows.length === 0) return;

  const firstRow = rows[0];
  if (!firstRow) return;
  const colWidths = firstRow.map((_, colIdx) =>
    Math.max(...rows.map((row) => stripAnsi(row[colIdx] ?? "").length))
  );

  for (const row of rows) {
    const line = row
      .map((cell, i) => padWithAnsi(cell, (colWidths[i] ?? 0) + 2))
      .join("")
      .trimEnd();
    console.log("  " + line);
  }
}

const NETWORK_PATTERNS = ["ECONNREFUSED", "ETIMEDOUT", "ENOTFOUND", "ENETUNREACH", "EAI_AGAIN"];

export function getErrorHint(err: unknown): string | undefined {
  if (!(err instanceof Error)) return undefined;
  const msg = err.message;
  if (NETWORK_PATTERNS.some((p) => msg.includes(p))) {
    return "Check your internet connection and try again.";
  }
  if (msg.includes("404") || msg.includes("Not Found")) {
    return "Skill not found. Run `arcana search <query>` to find skills.";
  }
  return undefined;
}

export function errorAndExit(message: string, hint?: string): never {
  console.error();
  console.error(ui.error("  Error: ") + message);
  if (hint) {
    console.error(ui.dim("  Hint: ") + hint);
  } else {
    console.error(ui.dim("  Hint: Run `arcana doctor` to diagnose"));
  }
  console.error();
  process.exit(1);
}
