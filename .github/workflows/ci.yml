name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 6 * * 1"

jobs:
  validate-skills:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate SKILL.md files
        run: |
          for skill_dir in skills/*/; do
            skill_name=$(basename "$skill_dir")
            echo "=== Validating $skill_name ==="

            if [ ! -f "$skill_dir/SKILL.md" ]; then
              echo "ERROR: $skill_name missing SKILL.md"
              exit 1
            fi

            if ! head -1 "$skill_dir/SKILL.md" | grep -q "^---"; then
              echo "ERROR: $skill_name SKILL.md missing frontmatter"
              exit 1
            fi

            lines=$(wc -l < "$skill_dir/SKILL.md")
            if [ "$lines" -gt 150 ]; then
              echo "WARNING: $skill_name SKILL.md has $lines lines (>150)"
            fi

            echo "PASSED: $skill_name"
          done

      - name: Run skill tests
        run: |
          for skill_dir in skills/*/; do
            skill_name=$(basename "$skill_dir")
            scripts_dir="$skill_dir/scripts"

            if [ ! -d "$scripts_dir" ]; then
              continue
            fi

            for test_file in "$scripts_dir"/test_*.py; do
              [ -f "$test_file" ] || continue
              echo "=== Running $(basename $test_file) for $skill_name ==="
              python "$test_file" -v
            done
          done

      - name: Check description quality
        run: |
          python3 -c "
          import os, sys
          errors = 0
          for skill_name in sorted(os.listdir('skills')):
              skill_dir = os.path.join('skills', skill_name)
              if not os.path.isdir(skill_dir):
                  continue
              skill_md = os.path.join(skill_dir, 'SKILL.md')
              if not os.path.isfile(skill_md):
                  continue
              with open(skill_md, 'r', encoding='utf-8') as f:
                  content = f.read()
              if not content.startswith('---'):
                  print(f'ERROR: {skill_name} missing frontmatter')
                  errors += 1
                  continue
              end = content.index('---', 3)
              fm = content[3:end].strip()
              lines = fm.split('\n')
              desc = ''
              for i, line in enumerate(lines):
                  if line.startswith('description:'):
                      value = line.split(':', 1)[1].strip().strip('\"').strip(\"'\")
                      if value in ('>', '|', '>-', '|-'):
                          # YAML multiline scalar - collect indented continuation lines
                          desc_parts = []
                          for next_line in lines[i+1:]:
                              if next_line and (next_line[0] == ' ' or next_line[0] == '\t'):
                                  desc_parts.append(next_line.strip())
                              else:
                                  break
                          desc = ' '.join(desc_parts)
                      else:
                          desc = value
                      break
              if not desc:
                  print(f'ERROR: {skill_name} has no description')
                  errors += 1
                  continue
              if len(desc) < 80:
                  print(f'ERROR: {skill_name} description too short ({len(desc)} chars)')
                  errors += 1
              elif len(desc) > 1024:
                  print(f'ERROR: {skill_name} description too long ({len(desc)} chars)')
                  errors += 1
              else:
                  print(f'OK: {skill_name} ({len(desc)} chars)')
          if errors > 0:
              sys.exit(1)
          "

      - name: Check for duplicate skill names
        run: |
          dupes=$(ls -1 skills/ | sort | uniq -d)
          if [ -n "$dupes" ]; then
            echo "ERROR: Duplicate skill names found:"
            echo "$dupes"
            exit 1
          fi
          echo "No duplicate skill names."

      - name: Validate marketplace.json
        run: |
          python3 -c "
          import json, sys, os
          data = json.load(open('.claude-plugin/marketplace.json'))
          assert 'name' in data, 'Missing name'
          assert 'plugins' in data, 'Missing plugins'

          names = set()
          for p in data['plugins']:
              assert 'name' in p, 'Plugin missing name'
              assert 'source' in p, f'Plugin {p.get(\"name\", \"?\")} missing source'
              assert 'description' in p, f'Plugin {p[\"name\"]} missing description'
              assert len(p['description']) >= 80, f'Plugin {p[\"name\"]} description too short ({len(p[\"description\"])} chars)'
              assert p['name'] not in names, f'Duplicate plugin: {p[\"name\"]}'
              names.add(p['name'])
              skill_path = p['source'].lstrip('./')
              assert os.path.isdir(skill_path), f'Plugin {p[\"name\"]} source dir missing: {p[\"source\"]}'

          print(f'Valid: {len(data[\"plugins\"])} plugins, no duplicates')
          "

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run security scan
        run: bash scripts/security-scan.sh

  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
        working-directory: cli
      - run: npm audit --audit-level=moderate
        working-directory: cli

  cli-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: cli/package-lock.json
      - run: npm ci
        working-directory: cli
      - name: Type check
        run: npx tsc --noEmit
        working-directory: cli
      - name: Unit tests
        run: npm test
        working-directory: cli
      - name: Smoke test
        run: |
          npx tsc
          node dist/index.js --version
          node dist/index.js --help
        working-directory: cli
